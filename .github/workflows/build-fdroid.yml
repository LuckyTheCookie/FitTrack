name: Build F-Droid APK

on:
  workflow_dispatch: # Permet de lancer manuellement le build
  push:
    tags:
      - 'v*' # Se dÃ©clenche sur les tags de version

jobs:
  build:
    name: Build & Sign APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Important pour avoir l'historique git pour SOURCE_DATE_EPOCH

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK
        run: |
          echo "y" | sdkmanager "ndk;26.1.10909125"
          echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV

      - name: Make script executable
        run: chmod +x scripts/fdroid-prebuild.sh

      - name: Run F-Droid Prebuild Script
        run: ./scripts/fdroid-prebuild.sh

      - name: Build Release APK
        working-directory: android
        run: ./gradlew assembleRelease

      - name: Verify Unsigned APK exists
        run: ls -la android/app/build/outputs/apk/release/app-release.apk

      # Upload Unsigned APK (Artifact 1)
      - name: Upload Unsigned APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-unsigned
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 5

      # Decode Keystore
      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore.jks

      # Sign APK
      - name: Sign APK
        run: |
          # Extraire la version du tag ou utiliser "debug"
          VERSION="${{ github.ref_name }}"
          if [[ "$VERSION" != v* ]]; then VERSION="debug"; else VERSION="${VERSION#v}"; fi
          
          # Signer
          $ANDROID_SDK_ROOT/build-tools/34.0.0/apksigner sign \
            --ks android/app/keystore.jks \
            --ks-key-alias "${{ secrets.KEYSTORE_ALIAS }}" \
            --ks-pass "pass:${{ secrets.KEYSTORE_PASSWORD }}" \
            --key-pass "pass:${{ secrets.KEYSTORE_PASSWORD }}" \
            --out "Spix-${VERSION}-FOSS.apk" \
            android/app/build/outputs/apk/release/app-release.apk

      # Upload Signed APK (Artifact 2)
      - name: Upload Signed APK
        uses: actions/upload-artifact@v4
        with:
          name: Spix-Signed-APK
          path: Spix-*-FOSS.apk
          retention-days: 5
